<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Position Size Calculator | FTMO & IG</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2234;
            --bg-card: #151d2e;
            --border-primary: #2a3548;
            --border-accent: #3b4a63;
            --text-primary: #e8edf5;
            --text-secondary: #8b97a8;
            --text-muted: #5a6678;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-green-dim: rgba(16, 185, 129, 0.15);
            --accent-red: #ef4444;
            --accent-red-dim: rgba(239, 68, 68, 0.15);
            --accent-amber: #f59e0b;
            --accent-amber-dim: rgba(245, 158, 11, 0.15);
            --accent-purple: #8b5cf6;
            --ftmo-color: #00c7b7;
            --ig-color: #ff6b6b;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.6; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 1px solid var(--border-primary); }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 42px; height: 42px; background: linear-gradient(135deg, var(--ftmo-color), var(--ig-color)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 18px; color: var(--bg-primary); }
        .logo-text h1 { font-size: 20px; font-weight: 600; }
        .logo-text span { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; }
        
        .btn { font-family: inherit; font-size: 14px; font-weight: 500; padding: 10px 18px; border-radius: var(--radius-sm); border: 1px solid var(--border-primary); background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn:hover { background: var(--bg-card); border-color: var(--border-accent); }
        .btn-primary { background: var(--accent-blue); border-color: var(--accent-blue); }
        
        .main-grid { display: grid; grid-template-columns: 380px 1fr; gap: 24px; }
        @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }
        
        .card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: var(--radius-lg); overflow: hidden; }
        .card-header { padding: 18px 22px; border-bottom: 1px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-secondary); }
        .card-body { padding: 22px; }
        
        .form-group { margin-bottom: 18px; }
        .form-label { display: block; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 8px; }
        .form-input, .form-select { width: 100%; padding: 12px 14px; font-family: 'JetBrains Mono', monospace; font-size: 15px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius-sm); color: var(--text-primary); transition: all 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        .form-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238b97a8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 40px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .input-with-suffix { position: relative; }
        .input-suffix { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-muted); }
        .input-with-suffix .form-input { padding-right: 45px; }
        
        .direction-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .direction-btn { padding: 12px; font-family: inherit; font-size: 14px; font-weight: 600; text-transform: uppercase; border: 2px solid var(--border-primary); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
        .direction-btn.buy.active { background: var(--accent-green-dim); border-color: var(--accent-green); color: var(--accent-green); }
        .direction-btn.sell.active { background: var(--accent-red-dim); border-color: var(--accent-red); color: var(--accent-red); }
        
        .calculate-btn { width: 100%; padding: 16px; margin-top: 8px; font-family: inherit; font-size: 15px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border: none; border-radius: var(--radius-sm); color: white; cursor: pointer; transition: all 0.2s; }
        .calculate-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.35); }
        
        .quick-risk { display: flex; gap: 8px; margin-top: 8px; }
        .quick-risk-btn { flex: 1; padding: 8px; font-family: 'JetBrains Mono', monospace; font-size: 12px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--text-secondary); cursor: pointer; transition: all 0.15s; }
        .quick-risk-btn:hover, .quick-risk-btn.active { border-color: var(--accent-blue); color: var(--accent-blue); }
        .quick-risk-btn.active { background: rgba(59, 130, 246, 0.15); }
        
        .pip-info-badge { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-muted); padding: 6px 12px; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-top: 8px; display: inline-block; }
        
        .results-wrapper { display: flex; flex-direction: column; gap: 20px; }
        
        .summary-table-wrapper { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: var(--radius-lg); overflow: hidden; }
        .summary-table-header { padding: 16px 22px; border-bottom: 1px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .instrument-badge { display: flex; align-items: center; gap: 12px; }
        .instrument-name { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; }
        .direction-badge { padding: 4px 10px; font-size: 11px; font-weight: 600; text-transform: uppercase; border-radius: 4px; }
        .direction-badge.long { background: var(--accent-green-dim); color: var(--accent-green); }
        .direction-badge.short { background: var(--accent-red-dim); color: var(--accent-red); }
        .rr-badge { padding: 6px 14px; font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; border-radius: var(--radius-sm); }
        .rr-badge.valid { background: var(--accent-green-dim); color: var(--accent-green); }
        .rr-badge.warning { background: var(--accent-amber-dim); color: var(--accent-amber); }
        .rr-badge.invalid { background: var(--accent-red-dim); color: var(--accent-red); }
        
        .price-levels { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border-primary); border-top: 1px solid var(--border-primary); }
        .price-level { padding: 16px 22px; background: var(--bg-card); text-align: center; }
        .price-level-label { font-size: 11px; font-weight: 500; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
        .price-level-value { font-family: 'JetBrains Mono', monospace; font-size: 16px; font-weight: 600; }
        .price-level-pips { font-family: 'JetBrains Mono', monospace; font-size: 12px; margin-top: 4px; }
        .price-level-money { font-family: 'JetBrains Mono', monospace; font-size: 11px; margin-top: 2px; color: var(--text-muted); }
        .price-level.sl .price-level-value, .price-level.sl .price-level-pips { color: var(--accent-red); }
        .price-level.tp .price-level-value, .price-level.tp .price-level-pips { color: var(--accent-green); }
        
        .summary-table { width: 100%; border-collapse: collapse; }
        .summary-table th { padding: 14px 22px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); background: var(--bg-secondary); border-bottom: 1px solid var(--border-primary); }
        .summary-table td { padding: 16px 22px; font-family: 'JetBrains Mono', monospace; font-size: 15px; border-bottom: 1px solid var(--border-primary); }
        .summary-table tr:last-child td { border-bottom: none; }
        .summary-table .broker-cell { font-family: 'IBM Plex Sans', sans-serif; font-weight: 600; }
        .summary-table .ftmo-label { color: var(--ftmo-color); }
        .summary-table .ig-label { color: var(--ig-color); }
        .summary-table .position-size { font-weight: 700; font-size: 17px; }
        .summary-table .ftmo-value { color: var(--ftmo-color); }
        .summary-table .ig-value { color: var(--ig-color); }
        .summary-table .risk-cell { color: var(--accent-red); }
        .summary-table .profit-cell { color: var(--accent-green); }
        .summary-table .account-cell { color: var(--text-secondary); }
        
        .narrative-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: var(--radius-lg); padding: 24px; }
        .narrative-title { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .narrative-title::before { content: ''; width: 4px; height: 16px; background: linear-gradient(135deg, var(--ftmo-color), var(--ig-color)); border-radius: 2px; }
        .narrative-text { font-size: 15px; line-height: 1.8; color: var(--text-secondary); }
        .narrative-text strong { color: var(--text-primary); font-weight: 600; }
        .narrative-section { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-primary); }
        .narrative-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .ftmo-hl { color: var(--ftmo-color); font-weight: 600; }
        .ig-hl { color: var(--ig-color); font-weight: 600; }
        .risk-hl { color: var(--accent-red); font-weight: 600; }
        .profit-hl { color: var(--accent-green); font-weight: 600; }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 80px 20px; text-align: center; background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: var(--radius-lg); }
        .empty-state-icon { width: 72px; height: 72px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 24px; }
        .empty-state-icon svg { width: 32px; height: 32px; stroke: var(--text-muted); }
        .empty-state h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .empty-state p { font-size: 14px; color: var(--text-muted); max-width: 300px; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: var(--radius-lg); width: 90%; max-width: 480px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; }
        .modal-body { padding: 24px; }
        .settings-section { margin-bottom: 28px; }
        .settings-section:last-child { margin-bottom: 0; }
        .settings-section-title { display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid var(--border-primary); }
        .settings-section-title .dot { width: 10px; height: 10px; border-radius: 50%; }
        .settings-section-title .dot.ftmo { background: var(--ftmo-color); }
        .settings-section-title .dot.ig { background: var(--ig-color); }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-primary); display: flex; gap: 12px; justify-content: flex-end; }
        
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 20px; background: var(--bg-card); border: 1px solid var(--accent-green); border-radius: var(--radius-sm); color: var(--accent-green); font-size: 14px; font-weight: 500; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 1001; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .kbd { display: inline-block; padding: 2px 6px; font-family: 'JetBrains Mono', monospace; font-size: 11px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--text-muted); }
        
        @media (max-width: 768px) {
            .app-container { padding: 16px; }
            .header { flex-direction: column; gap: 16px; align-items: flex-start; }
            .form-row { grid-template-columns: 1fr; }
            .price-levels { grid-template-columns: 1fr; }
            .summary-table { font-size: 13px; }
            .summary-table th, .summary-table td { padding: 12px 16px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">PS</div>
                <div class="logo-text">
                    <h1>Position Calculator</h1>
                    <span>FTMO & IG Spreadbetting</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn" onclick="openSettings()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    Settings
                </button>
            </div>
        </header>

        <div class="main-grid">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Trade Parameters</span>
                    <span class="kbd">Enter ↵</span>
                </div>
                <div class="card-body">
                    <form id="calcForm" onsubmit="calculate(event)">
                        <div class="form-group">
                            <label class="form-label">Instrument</label>
                            <select class="form-select" id="instrument" onchange="updatePipInfo()">
                                <optgroup label="Major Pairs">
                                    <option value="EURUSD">EUR/USD</option>
                                    <option value="GBPUSD">GBP/USD</option>
                                    <option value="USDJPY">USD/JPY</option>
                                    <option value="USDCHF">USD/CHF</option>
                                    <option value="AUDUSD">AUD/USD</option>
                                    <option value="USDCAD">USD/CAD</option>
                                    <option value="NZDUSD">NZD/USD</option>
                                </optgroup>
                                <optgroup label="JPY Crosses">
                                    <option value="EURJPY">EUR/JPY</option>
                                    <option value="GBPJPY">GBP/JPY</option>
                                    <option value="AUDJPY">AUD/JPY</option>
                                    <option value="CADJPY">CAD/JPY</option>
                                    <option value="CHFJPY">CHF/JPY</option>
                                    <option value="NZDJPY">NZD/JPY</option>
                                </optgroup>
                                <optgroup label="Other Crosses">
                                    <option value="EURGBP">EUR/GBP</option>
                                    <option value="EURCHF">EUR/CHF</option>
                                    <option value="GBPCHF">GBP/CHF</option>
                                    <option value="EURAUD">EUR/AUD</option>
                                    <option value="EURCAD">EUR/CAD</option>
                                    <option value="GBPAUD">GBP/AUD</option>
                                    <option value="GBPCAD">GBP/CAD</option>
                                    <option value="AUDCAD">AUD/CAD</option>
                                    <option value="AUDNZD">AUD/NZD</option>
                                </optgroup>
                                <optgroup label="Metals & Commodities">
                                    <option value="XAUUSD">XAU/USD (Gold)</option>
                                    <option value="XAGUSD">XAG/USD (Silver)</option>
                                    <option value="USOIL">US Oil (WTI)</option>
                                </optgroup>
                            </select>
                            <div class="pip-info-badge" id="pipInfoBadge">1 pip = 0.0001 • $10/lot</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Direction</label>
                            <div class="direction-toggle">
                                <button type="button" class="direction-btn buy active" onclick="setDirection('buy')">↑ Long / Buy</button>
                                <button type="button" class="direction-btn sell" onclick="setDirection('sell')">↓ Short / Sell</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Entry Price</label>
                            <input type="text" class="form-input" id="entryPrice" placeholder="1.08500" inputmode="decimal">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Stop Loss</label>
                                <input type="text" class="form-input" id="stopLoss" placeholder="1.08200" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Take Profit</label>
                                <input type="text" class="form-input" id="takeProfit" placeholder="1.09100" inputmode="decimal">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Risk per Trade</label>
                            <div class="input-with-suffix">
                                <input type="text" class="form-input" id="riskPercent" placeholder="0.5" inputmode="decimal">
                                <span class="input-suffix">%</span>
                            </div>
                            <div class="quick-risk">
                                <button type="button" class="quick-risk-btn" data-risk="0.25">0.25%</button>
                                <button type="button" class="quick-risk-btn" data-risk="0.5">0.5%</button>
                                <button type="button" class="quick-risk-btn active" data-risk="1">1%</button>
                                <button type="button" class="quick-risk-btn" data-risk="2">2%</button>
                            </div>
                        </div>

                        <button type="submit" class="calculate-btn">Calculate Position Size</button>
                    </form>
                </div>
            </div>

            <div class="results-wrapper">
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 7h6m-6 4h6m-6 4h4M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/></svg>
                    </div>
                    <h3>Ready to Calculate</h3>
                    <p>Enter your trade parameters and hit calculate to see position sizes for both accounts</p>
                </div>

                <div id="resultsContent" style="display: none;">
                    <div class="summary-table-wrapper">
                        <div class="summary-table-header">
                            <div class="instrument-badge">
                                <span class="instrument-name" id="resultInstrument">EUR/USD</span>
                                <span class="direction-badge long" id="resultDirection">LONG</span>
                            </div>
                            <span class="rr-badge valid" id="rrBadge">R:R 1:2.00</span>
                        </div>
                        <div class="price-levels">
                            <div class="price-level sl">
                                <div class="price-level-label">Stop Loss</div>
                                <div class="price-level-value" id="slPrice">1.08200</div>
                                <div class="price-level-pips" id="slPips">-30 pips</div>
                                <div class="price-level-money" id="slMoney">-£350</div>
                            </div>
                            <div class="price-level entry">
                                <div class="price-level-label">Entry</div>
                                <div class="price-level-value" id="entryPriceDisplay">1.08500</div>
                                <div class="price-level-pips">&nbsp;</div>
                                <div class="price-level-money">&nbsp;</div>
                            </div>
                            <div class="price-level tp">
                                <div class="price-level-label">Take Profit</div>
                                <div class="price-level-value" id="tpPrice">1.09100</div>
                                <div class="price-level-pips" id="tpPips">+60 pips</div>
                                <div class="price-level-money" id="tpMoney">+£700</div>
                            </div>
                        </div>
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th>Broker</th>
                                    <th>Position Size</th>
                                    <th>Risk</th>
                                    <th>Potential Profit</th>
                                    <th>Account</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="broker-cell ftmo-label">FTMO (MT5)</td>
                                    <td class="position-size ftmo-value" id="ftmoSize">0.35 lots</td>
                                    <td class="risk-cell" id="ftmoRisk">£350.00</td>
                                    <td class="profit-cell" id="ftmoProfit">£700.00</td>
                                    <td class="account-cell" id="ftmoAccount">£70,000</td>
                                </tr>
                                <tr>
                                    <td class="broker-cell ig-label">IG (MT4)</td>
                                    <td class="position-size ig-value" id="igSize">£11.67/pt</td>
                                    <td class="risk-cell" id="igRisk">£350.00</td>
                                    <td class="profit-cell" id="igProfit">£700.00</td>
                                    <td class="account-cell" id="igAccount">£10,000</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="narrative-card">
                        <div class="narrative-title">Trade Summary</div>
                        <div class="narrative-text" id="narrativeText"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Account Settings</h2>
                <button class="modal-close" onclick="closeSettings()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-section-title"><span class="dot ftmo"></span>FTMO Account</div>
                    <div class="form-group">
                        <label class="form-label">Account Size</label>
                        <div class="input-with-suffix">
                            <input type="text" class="form-input" id="ftmoAccountSize" placeholder="70000" inputmode="decimal">
                            <span class="input-suffix">£</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Account Currency</label>
                        <select class="form-select" id="ftmoCurrency">
                            <option value="GBP">GBP (£)</option>
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                        </select>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title"><span class="dot ig"></span>IG Spreadbetting Account</div>
                    <div class="form-group">
                        <label class="form-label">Account Size</label>
                        <div class="input-with-suffix">
                            <input type="text" class="form-input" id="igAccountSize" placeholder="10000" inputmode="decimal">
                            <span class="input-suffix">£</span>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">Default Settings</div>
                    <div class="form-group">
                        <label class="form-label">Default Risk %</label>
                        <div class="input-with-suffix">
                            <input type="text" class="form-input" id="defaultRisk" placeholder="0.5" inputmode="decimal">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Minimum R:R Warning</label>
                        <div class="input-with-suffix">
                            <input type="text" class="form-input" id="minRR" placeholder="2" inputmode="decimal">
                            <span class="input-suffix">:1</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Settings saved</div>

    <script>
        // ============================================
        // STATE & CONFIG
        // ============================================
        let settings = { ftmoAccountSize: 70000, ftmoCurrency: 'GBP', igAccountSize: 10000, defaultRisk: 0.5, minRR: 2 };
        let tradeDirection = 'buy';

        // INSTRUMENT CONFIGS - Proper pip handling for JPY, Gold, Silver, Oil
        const instruments = {
            // Standard pairs: pip = 0.0001, ~$10/lot for USD quoted
            EURUSD: { pipSize: 0.0001, pipValueUSD: 10, name: 'EUR/USD', type: 'standard' },
            GBPUSD: { pipSize: 0.0001, pipValueUSD: 10, name: 'GBP/USD', type: 'standard' },
            AUDUSD: { pipSize: 0.0001, pipValueUSD: 10, name: 'AUD/USD', type: 'standard' },
            NZDUSD: { pipSize: 0.0001, pipValueUSD: 10, name: 'NZD/USD', type: 'standard' },
            USDCHF: { pipSize: 0.0001, pipValueUSD: 11.24, name: 'USD/CHF', type: 'standard' },
            USDCAD: { pipSize: 0.0001, pipValueUSD: 7.35, name: 'USD/CAD', type: 'standard' },
            
            // JPY pairs: pip = 0.01 (2 decimal places!)
            USDJPY: { pipSize: 0.01, pipValueUSD: 6.67, name: 'USD/JPY', type: 'jpy' },
            EURJPY: { pipSize: 0.01, pipValueUSD: 6.67, name: 'EUR/JPY', type: 'jpy' },
            GBPJPY: { pipSize: 0.01, pipValueUSD: 6.67, name: 'GBP/JPY', type: 'jpy' },
            AUDJPY: { pipSize: 0.01, pipValueUSD: 6.67, name: 'AUD/JPY', type: 'jpy' },
            CADJPY: { pipSize: 0.01, pipValueUSD: 6.67, name: 'CAD/JPY', type: 'jpy' },
            CHFJPY: { pipSize: 0.01, pipValueUSD: 6.67, name: 'CHF/JPY', type: 'jpy' },
            NZDJPY: { pipSize: 0.01, pipValueUSD: 6.67, name: 'NZD/JPY', type: 'jpy' },
            
            // Other crosses
            EURGBP: { pipSize: 0.0001, pipValueUSD: 12.66, name: 'EUR/GBP', type: 'standard' },
            EURCHF: { pipSize: 0.0001, pipValueUSD: 11.24, name: 'EUR/CHF', type: 'standard' },
            GBPCHF: { pipSize: 0.0001, pipValueUSD: 11.24, name: 'GBP/CHF', type: 'standard' },
            EURAUD: { pipSize: 0.0001, pipValueUSD: 6.49, name: 'EUR/AUD', type: 'standard' },
            EURCAD: { pipSize: 0.0001, pipValueUSD: 7.35, name: 'EUR/CAD', type: 'standard' },
            GBPAUD: { pipSize: 0.0001, pipValueUSD: 6.49, name: 'GBP/AUD', type: 'standard' },
            GBPCAD: { pipSize: 0.0001, pipValueUSD: 7.35, name: 'GBP/CAD', type: 'standard' },
            AUDCAD: { pipSize: 0.0001, pipValueUSD: 7.35, name: 'AUD/CAD', type: 'standard' },
            AUDNZD: { pipSize: 0.0001, pipValueUSD: 6.10, name: 'AUD/NZD', type: 'standard' },
            
            // GOLD: pip = $0.10, contract = 100oz, pip value = $10/lot
            XAUUSD: { pipSize: 0.1, pipValueUSD: 10, name: 'XAU/USD (Gold)', type: 'gold' },
            
            // SILVER: pip = $0.001, contract = 5000oz, pip value = $5/lot  
            XAGUSD: { pipSize: 0.001, pipValueUSD: 5, name: 'XAG/USD (Silver)', type: 'silver' },
            
            // OIL: pip = $0.01, pip value = $10/lot
            USOIL: { pipSize: 0.01, pipValueUSD: 10, name: 'US Oil (WTI)', type: 'oil' }
        };

        const exchangeRates = { GBPUSD: 1.27, EURUSD: 1.08, USDJPY: 150 };

        // ============================================
        // INIT
        // ============================================
        function init() {
            const saved = localStorage.getItem('tradingCalcSettings');
            if (saved) settings = { ...settings, ...JSON.parse(saved) };
            document.getElementById('riskPercent').value = settings.defaultRisk;
            updateQuickRiskButtons();
            updatePipInfo();
            
            document.querySelectorAll('.quick-risk-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('riskPercent').value = btn.dataset.risk;
                    updateQuickRiskButtons();
                });
            });
            
            document.getElementById('riskPercent').addEventListener('input', updateQuickRiskButtons);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !document.getElementById('settingsModal').classList.contains('active')) {
                    e.preventDefault();
                    calculate(e);
                }
                if (e.key === 'Escape') closeSettings();
            });
        }

        function updateQuickRiskButtons() {
            const v = document.getElementById('riskPercent').value;
            document.querySelectorAll('.quick-risk-btn').forEach(b => b.classList.toggle('active', b.dataset.risk === v));
        }

        function updatePipInfo() {
            const inst = instruments[document.getElementById('instrument').value];
            const badge = document.getElementById('pipInfoBadge');
            if (inst.type === 'jpy') badge.textContent = `1 pip = 0.01 • ~$${inst.pipValueUSD.toFixed(2)}/lot`;
            else if (inst.type === 'gold') badge.textContent = `1 pip = $0.10 • $${inst.pipValueUSD}/lot (100oz)`;
            else if (inst.type === 'silver') badge.textContent = `1 pip = $0.001 • $${inst.pipValueUSD}/lot (5000oz)`;
            else if (inst.type === 'oil') badge.textContent = `1 pip = $0.01 • $${inst.pipValueUSD}/lot`;
            else badge.textContent = `1 pip = 0.0001 • $${inst.pipValueUSD}/lot`;
        }

        function setDirection(dir) {
            tradeDirection = dir;
            document.querySelectorAll('.direction-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.direction-btn.${dir}`).classList.add('active');
        }

        // ============================================
        // CALCULATION
        // ============================================
        function calculate(e) {
            if (e) e.preventDefault();
            
            const instrumentId = document.getElementById('instrument').value;
            const entry = parseFloat(document.getElementById('entryPrice').value);
            const sl = parseFloat(document.getElementById('stopLoss').value);
            const tp = parseFloat(document.getElementById('takeProfit').value);
            const riskPct = parseFloat(document.getElementById('riskPercent').value);
            
            if (!entry || !sl || !tp || !riskPct) { showToast('Fill in all fields'); return; }
            
            const inst = instruments[instrumentId];
            const slDist = Math.abs(entry - sl);
            const tpDist = Math.abs(tp - entry);
            const slPips = Math.round(slDist / inst.pipSize);
            const tpPips = Math.round(tpDist / inst.pipSize);
            const rr = tpPips / slPips;
            
            // FTMO calc
            const currSym = settings.ftmoCurrency === 'GBP' ? '£' : settings.ftmoCurrency === 'EUR' ? '€' : '$';
            const ftmoRisk = settings.ftmoAccountSize * (riskPct / 100);
            let pipVal = inst.pipValueUSD;
            if (settings.ftmoCurrency === 'GBP') pipVal = inst.pipValueUSD / exchangeRates.GBPUSD;
            else if (settings.ftmoCurrency === 'EUR') pipVal = inst.pipValueUSD / exchangeRates.EURUSD;
            const ftmoLots = ftmoRisk / (slPips * pipVal);
            const ftmoProfit = tpPips * pipVal * ftmoLots;
            
            // IG calc - £ per point
            const igRisk = settings.igAccountSize * (riskPct / 100);
            const igPerPoint = igRisk / slPips;
            const igProfit = tpPips * igPerPoint;
            
            // Show results
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'flex';
            document.getElementById('resultsContent').style.flexDirection = 'column';
            document.getElementById('resultsContent').style.gap = '20px';
            
            // Header
            document.getElementById('resultInstrument').textContent = inst.name;
            const dirBadge = document.getElementById('resultDirection');
            dirBadge.textContent = tradeDirection === 'buy' ? 'LONG' : 'SHORT';
            dirBadge.className = 'direction-badge ' + (tradeDirection === 'buy' ? 'long' : 'short');
            
            const rrBadge = document.getElementById('rrBadge');
            rrBadge.textContent = `R:R 1:${rr.toFixed(2)}`;
            rrBadge.className = 'rr-badge ' + (rr >= settings.minRR ? 'valid' : rr >= 1 ? 'warning' : 'invalid');
            
            // Price levels with pip values
            const pipLabel = inst.type === 'jpy' ? 'pips (0.01)' : inst.type === 'gold' ? 'pips ($0.10)' : inst.type === 'silver' ? 'pips ($0.001)' : 'pips';
            document.getElementById('slPrice').textContent = sl;
            document.getElementById('entryPriceDisplay').textContent = entry;
            document.getElementById('tpPrice').textContent = tp;
            document.getElementById('slPips').textContent = `-${slPips} ${pipLabel}`;
            document.getElementById('tpPips').textContent = `+${tpPips} ${pipLabel}`;
            document.getElementById('slMoney').textContent = `-${currSym}${fmt(ftmoRisk)}`;
            document.getElementById('tpMoney').textContent = `+${currSym}${fmt(ftmoProfit)}`;
            
            // Table
            document.getElementById('ftmoSize').textContent = `${ftmoLots.toFixed(2)} lots`;
            document.getElementById('ftmoRisk').textContent = `${currSym}${fmt(ftmoRisk)}`;
            document.getElementById('ftmoProfit').textContent = `${currSym}${fmt(ftmoProfit)}`;
            document.getElementById('ftmoAccount').textContent = `${currSym}${fmt(settings.ftmoAccountSize)}`;
            
            document.getElementById('igSize').textContent = `£${igPerPoint.toFixed(2)}/pt`;
            document.getElementById('igRisk').textContent = `£${fmt(igRisk)}`;
            document.getElementById('igProfit').textContent = `£${fmt(igProfit)}`;
            document.getElementById('igAccount').textContent = `£${fmt(settings.igAccountSize)}`;
            
            // Narrative
            const dir = tradeDirection === 'buy' ? 'long' : 'short';
            let note = '';
            if (inst.type === 'jpy') note = `<em>JPY pair — 1 pip = 0.01, pip value ≈ $${inst.pipValueUSD.toFixed(2)}/lot at current rates.</em>`;
            else if (inst.type === 'gold') note = `<em>Gold — 1 pip = $0.10 movement, $10/pip per standard lot (100oz contract).</em>`;
            else if (inst.type === 'silver') note = `<em>Silver — 1 pip = $0.001 movement, $5/pip per standard lot (5000oz contract).</em>`;
            else if (inst.type === 'oil') note = `<em>Oil — 1 pip = $0.01 movement, $10/pip per standard lot.</em>`;
            
            const rrComment = rr >= settings.minRR 
                ? `That's a clean <span class="profit-hl">1:${rr.toFixed(2)}</span> R:R. Solid setup.`
                : rr >= 1 
                    ? `R:R of <span style="color:var(--accent-amber);font-weight:600">1:${rr.toFixed(2)}</span> is below your ${settings.minRR}:1 threshold. Proceed with caution.`
                    : `R:R of <span class="risk-hl">1:${rr.toFixed(2)}</span> is negative expectancy. Hard pass.`;
            
            document.getElementById('narrativeText').innerHTML = `
                <div class="narrative-section">
                    <strong>The Play:</strong> Going <strong>${dir}</strong> on <strong>${inst.name}</strong> at <strong>${entry}</strong>. 
                    Stop at <span class="risk-hl">${sl}</span> (${slPips} pips risk), target at <span class="profit-hl">${tp}</span> (${tpPips} pips reward). ${rrComment}
                </div>
                <div class="narrative-section">
                    <strong>FTMO:</strong> Risking <strong>${riskPct}%</strong> of your <span class="ftmo-hl">${currSym}${fmt(settings.ftmoAccountSize)}</span> account = <span class="risk-hl">${currSym}${fmt(ftmoRisk)}</span> on the line. 
                    Size up at <span class="ftmo-hl">${ftmoLots.toFixed(2)} standard lots</span>. 
                    Hit TP and you bank <span class="profit-hl">${currSym}${fmt(ftmoProfit)}</span>. ${note}
                </div>
                <div class="narrative-section">
                    <strong>IG Spreadbet:</strong> Same <strong>${riskPct}%</strong> risk on <span class="ig-hl">£${fmt(settings.igAccountSize)}</span> = <span class="risk-hl">£${fmt(igRisk)}</span>. 
                    That's <span class="ig-hl">£${igPerPoint.toFixed(2)} per point</span>. 
                    TP hit = <span class="profit-hl">£${fmt(igProfit)}</span> profit, tax-free. 
                    Remember: ${slPips} points to SL, ${tpPips} points to TP.
                </div>
                ${rr < 1 ? '<div class="narrative-section" style="background:var(--accent-red-dim);padding:12px;border-radius:6px;margin-top:8px;">⚠️ <strong>Warning:</strong> Negative R:R. You\'re risking more than you can gain. Consider adjusting your levels.</div>' : ''}
            `;
        }

        // ============================================
        // SETTINGS & UTILITIES
        // ============================================
        function openSettings() {
            document.getElementById('ftmoAccountSize').value = settings.ftmoAccountSize;
            document.getElementById('ftmoCurrency').value = settings.ftmoCurrency;
            document.getElementById('igAccountSize').value = settings.igAccountSize;
            document.getElementById('defaultRisk').value = settings.defaultRisk;
            document.getElementById('minRR').value = settings.minRR;
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }
        
        function saveSettings() {
            settings.ftmoAccountSize = parseFloat(document.getElementById('ftmoAccountSize').value) || 70000;
            settings.ftmoCurrency = document.getElementById('ftmoCurrency').value;
            settings.igAccountSize = parseFloat(document.getElementById('igAccountSize').value) || 10000;
            settings.defaultRisk = parseFloat(document.getElementById('defaultRisk').value) || 0.5;
            settings.minRR = parseFloat(document.getElementById('minRR').value) || 2;
            localStorage.setItem('tradingCalcSettings', JSON.stringify(settings));
            closeSettings();
            showToast('Settings saved');
        }
        
        document.getElementById('settingsModal').addEventListener('click', e => { if (e.target.id === 'settingsModal') closeSettings(); });
        
        function fmt(n) { return parseFloat(n).toLocaleString('en-GB', { minimumFractionDigits: 0, maximumFractionDigits: 2 }); }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
